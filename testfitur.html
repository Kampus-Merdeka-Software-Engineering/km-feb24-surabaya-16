<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stacked Bar Chart of Sales</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.3.2/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <canvas id="StackedBarChartSalesPerState" width="400" height="200"></canvas>
    <button id="downloadPDF">Download as PDF</button>
    <script>
        const DataUrl = 'http://localhost:3000/data';
        const colorPalette = ['#1B1A17', '#F0A500', '#E45826', '#E6D5B8'];

        // Function to fetch data from the given URL
        function fetchData(url) {
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        // Function to process data and calculate sales per category in each state
        function processStackedBarChartSalesDataPerCategory(data) {
            const SalesDataPerCategory = {};

            data.forEach(item => {
                const state = item["State"];
                const category = item["Category"];
                const sales = parseFloat(item["Sales"].replace('$', '').replace(',', '.'));

                if (!SalesDataPerCategory[state]) {
                    SalesDataPerCategory[state] = {};
                }
                if (SalesDataPerCategory[state][category]) {
                    SalesDataPerCategory[state][category] += sales;
                } else {
                    SalesDataPerCategory[state][category] = sales;
                }
            });

            return SalesDataPerCategory;
        }

        // Function to prepare chart data for Chart.js
        function prepareStackedChartData(SalesDataPerCategory) {
            const states = Object.keys(SalesDataPerCategory);
            const categories = new Set();

            states.forEach(state => {
                Object.keys(SalesDataPerCategory[state]).forEach(category => {
                    categories.add(category);
                });
            });

            const totalSalesByState = states.map(state => {
                return {
                    state: state,
                    totalSales: Object.values(SalesDataPerCategory[state]).reduce((a, b) => a + b, 0)
                };
            });

            totalSalesByState.sort((a, b) => b.totalSales - a.totalSales);

            // Select top 10 states by total sales
            const topStates = totalSalesByState.slice(0, 10).map(item => item.state);

            const datasets = Array.from(categories).map((category, index) => {
                return {
                    label: category,
                    data: topStates.map(state => SalesDataPerCategory[state][category] || 0),
                    backgroundColor: colorPalette[index % colorPalette.length]
                };
            });

            return {
                labels: topStates,
                datasets: datasets
            };
        }

        let StackedBarChart = null;

        function createStackedBarChart(chartData) {
            const ctxSBC = document.getElementById('StackedBarChartSalesPerState').getContext('2d');
            if (StackedBarChart != null) {
                StackedBarChart.data = chartData;
                return StackedBarChart.update();
            }

            StackedBarChart = new Chart(ctxSBC, {
                type: 'bar',
                data: chartData,
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Dummy filter function - replace with actual filter logic if needed
        function applyFilters(data) {
            // Add your filter logic here, for now it returns the data unfiltered
            return data;
        }

        // Fetch, process, and render the data
        function filterStackedBarChart() {
            fetchData(DataUrl).then(data => {
                if (data) {
                    const filteredData = applyFilters(data);
                    const SalesDataPerCategory = processStackedBarChartSalesDataPerCategory(filteredData);
                    const chartData = prepareStackedChartData(SalesDataPerCategory);
                    createStackedBarChart(chartData);
                }
            });
        }

        // Initial call to load the chart
        filterStackedBarChart();

        // Function to download the page as a PDF
        document.getElementById('downloadPDF').addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            html2canvas(document.body).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('page.pdf');
            });
        });
    </script>
</body>
</html>
